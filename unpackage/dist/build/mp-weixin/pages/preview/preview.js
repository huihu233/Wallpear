"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/system.js"),l=require("../../api/apis.js"),o=require("../../utils/common.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-rate")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const u={__name:"preview",setup(u){const t=a.getStatusBarHeight(),n=e.ref(!0),s=e.ref(null),i=e.ref(null),r=e.ref(0),c=e.ref(0),v=e.ref(""),d=e.ref(0),p=e.ref(null),m=e.ref([0]),f=e.ref(!1);e.onLoad((async a=>{if(v.value=a.id,a.id||o.gotoHome(),"share"==a.type){const a=await l.apiDetailWall({id:v.value});c.value=e.index.getStorageSync("storgClassList")||a.data,c.value=g(c.value),d.value=c.value.findIndex((e=>e._id==v.value)),p.value=c.value[d.value],x()}else{let a=e.index.getStorageSync("storgClassList")||[];c.value=g(a),d.value=c.value.findIndex((e=>e._id==v.value)),p.value=c.value[d.value],x()}}));const g=e=>e.map((e=>({...e,picurl:e.smallPicurl.replace("_small.webp",".jpg")})));function h(e){const{detail:{current:a}}=e;d.value=a,p.value=c.value[d.value],x()}function x(){m.value.push(d.value-1<=0?c.value.length-1:d.value-1,d.value,d.value+1>=c.value.length-1?1:d.value+1),m.value=[...new Set(m.value)]}const w=()=>{n.value=!n.value},y=()=>{s.value.open("bottom")},_=()=>{s.value.close()},S=()=>{p.value.userScore&&(f.value=!0,r.value=p.value.userScore),i.value.open("center")},b=()=>{i.value.close(),r.value=0,f.value=!1},L=async()=>{e.index.showLoading({title:"提交中",mask:!0});const a=p.value.classid,o=p.value._id,u=await l.apiSetScore({classid:a,wallId:o,userScore:r.value});e.index.hideLoading(),0===u.errCode&&(e.index.showToast({title:"添加成功",icon:"none"}),c.value[d.value].userScore=r.value,e.index.setStorageSync("storgClassList",c.value),b())};async function j(){try{e.index.showLoading({title:"下载中...",mask:!0});let{classid:a,_id:o}=p.value;await l.apiWriteDownload({classid:a,wallId:o});e.index.getImageInfo({src:p.value.picurl,success(a){console.log(a),e.index.saveImageToPhotosAlbum({filePath:a.path,success(e){console.log(e)},fail:a=>{(a.errMsg="saveImageToPhotosAlbum:fail cancel")?e.index.showToast({title:"保存失败,请从新下载",icon:"none"}):e.index.showModal({title:"授权提示",content:"需要授权保存相册",success:a=>{a.confirm&&e.index.openSetting({success(a){a.authSetting["scope.writePhotosAlbum"]?e.index.showToast({title:"授权成功",icon:"none"}):e.index.showToast({title:"授权失败",icon:"none"})}})}})},complete:()=>{e.index.hideLoading()}})}})}catch(a){console.log(a),e.index.hideLoading()}}const k=()=>{e.index.navigateBack({success:()=>{},fail:a=>{e.index.reLaunch({url:"/pages/index/index"})}})};return e.onShareAppMessage((()=>({title:"壁纸详情",path:"/pages/preview/preview?id="+v.value+"&type=share"}))),(a,l)=>e.e({a:p.value},p.value?e.e({b:e.f(c.value,((a,l,o)=>e.e({a:m.value.includes(l)},m.value.includes(l)?{b:e.o(w,a._id),c:a.picurl}:{},{d:a._id}))),c:d.value,d:e.o(h),e:n.value},n.value?{f:e.p({type:"back",color:"#fff",size:"20"}),g:e.unref(t)+"px",h:e.o(k),i:e.t(d.value+1),j:e.t(c.value.length),k:e.p({date:new Date,format:"hh:mm"}),l:e.p({date:new Date,format:"MM月dd日"}),m:e.p({type:"info",size:"28"}),n:e.o(y),o:e.p({type:"star",size:"28"}),p:e.t(p.value.score),q:e.o(S),r:e.p({type:"download",size:"23"}),s:e.o(j)}:{},{t:e.o(_),v:e.p({type:"closeempty",size:"18",color:"#999"}),w:p.value},p.value?{x:e.t(p.value._id),y:e.t(p.value.nickname),z:e.p({readonly:!0,touchable:"false",value:p.value.score}),A:e.t(p.value.score),B:e.t(p.value.description),C:e.f(p.value.tabs,((a,l,o)=>({a:e.t(a),b:a})))}:{},{D:e.sr(s,"de797396-6",{k:"infoPopup"}),E:e.p({"background-color":"#fff","border-radius":"30px 30px 0 0"}),F:e.t(f.value?"评分过了~":"壁纸评分"),G:e.o(b),H:e.p({type:"closeempty",size:"18",color:"#999"}),I:e.o((e=>r.value=e)),J:e.p({touchable:"true","allow-half":!0,"disabled-color":"#ffca3e",disabled:f.value,modelValue:r.value}),K:e.t(r.value?r.value:0),L:e.o(L),M:!r.value||f.value,N:e.sr(i,"de797396-9",{k:"scorePopup"})}):{})}},t=e._export_sfc(u,[["__scopeId","data-v-de797396"]]);u.__runtimeHooks=2,wx.createPage(t);
